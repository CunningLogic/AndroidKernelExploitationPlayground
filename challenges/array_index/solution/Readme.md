We are somewhat mimicking the socket_diag bug [CVE-2013-1763](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-1763).  There is a good writeup about it [here](http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2013-1763)

A contrived example of the bug looks like this:

Some handlers (handler1, handler2, handler2) are pre-defined functions for use to operate on some data.

```c
typedef struct {
  int (* handle_data)(void);
} CommandHandler;

CommandHandler handlers[] = { handler1 , handler2, handler3 };
```

Later a command handler is selected from the list based on user controlled input, but the index into the handler list is not first validated to make sure that it is valid. This is called an out-of-bounds access.
```c
  CommandHandler current = handlers[user_controlled_index];
```

At some later time that command handler is used on some data.
```
int some_data = 0x1337;
current.handle_data(some_data);
```
In order to exploit this we want to choose an index that would cause a dereference to memory that we can map in userspace

```
                        +----+                    +------------+
                        |   Handler[0] 0xC00C4914 | 0xC00C1000 |+------------+
                        |                         +------------+             |
    cmd_handlers[]<-----+   Handler[1] 0xC00C4910 | 0xC00C0F00 |+-------------------+
                        |                         +------------+             |      |
                        |   Handler[2] 0xC00C490C | 0xC00C0300 |+---------------------------+
                        +----+                    +------------+             |      |       |
                                       0xC00C4908 | 0x00000000 |+-----------------------+   |
                                                  +------------+             |      |   |   |
                                       0xC00C4904 | 0xDEADBEEF |             |      |   |   |
                                                  +------------+             |      |   |   |
                                       0xC00C4900 | 0x004004F4 |+--------+   |      |   |   |
                                                  +------------+         |   |      |   |   |
                                                    .........            |   |      |   |   |
                                                  +------------+         |   |      |   |   |
        Executable code for handler[0] 0xC00C1000 |            | <-------|---+      |   |   |
                                                  +------------+         |          |   |   |
                                                     .........           |          |   |   |
                                                  +------------+         |          |   |   |
        Executable code for handler[1] 0xC00C0F00 |            | <-------|----------+   |   |
                                                  +------------+         |              |   |
                                                    .........            |              |   |
                                                  +------------+         |              |   |
        Executable code for handler[2] 0xC00C0300 |            | <-------|--------------|---+
                                                  +------------+         |              |
                                                  |            |         |              |
                                                  +------------+         |              |
                                                    ..........           |              |
                                                    Userspace            |              |
                                            +------------------------+   |              |
                                                  +------------+         |              |
                                                  |            |         |              |
                                                  +------------+         |              |
                                                     .........           |              |
                                                                         |              |
                                                  +------------+         |              |
                                                  | 0x00000000 |         |              |
                                                  +------------+         |              |
                                       0x004004F4 | 0x00000000 | <-------+              |
                                                  +------------+                        |
                                                  | 0x00000000 |                        |
                                                  +------------+                        |
              shell code goes here -->            |            |                        |
                                                  +------------+                        |
                                                     .........                          |
                                                  +------------+                        |
                     mmap_min_address             |            |                        |
                                                  +------------+                        |
                                                     .........                          |
                                                  +------------+                        |
                                       0x0000000  |            |<-----------------------+
                                                  +------------+
```
