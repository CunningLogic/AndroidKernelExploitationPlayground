#Linux Kernel Exploitation on Android#
This repository is meant to serve as a hands on guide to Linux kernel exploitation with a special interest in Android. All the resources you need for setting up an exploitation play ground will be explained below.  Each folder should have it's own challenge in the form of a loadable kernel module, it's own solution - code that will be executed from userspace to take advantage of the vulnerability (usually to gain us root), and a bit of a writeup about the vulnerability and the exploit.  

I am hoping that this will serve as a jumpstart for people to get started with kernel exploitation as well as a learning exercise for myself.  Feel free to fork and submit pull reqs for new challenges, documentations, etc..

## Exploitation Assumptions

### Kernel symbols
Once we have managed to cause some memory corruption that we can control, we usually need to know where some of the symbols (pointers to functions, fields, structures, etc..) are located in memory.  There exists a kernel proc entry which lists all of the symbols and their locations.  This information can be read from userspace from the file located at ```/proc/kallsyms```. There is a proc interface kallsyms which names the exported kernel symbol as well as the address at which it is located. 

In recent kernel versions, in order to make exploitation of kernel bugs more difficult, have restricted these symbols for viewing only by those with CAP_SYS_ADMIN privledeges.  You can read the sematics of kptr_restrict submitted by Dan Rosenberg, et al. [here](http://lwn.net/Articles/420403/) and with respect to Android [here](http://insitusec.blogspot.com/2013/01/kallsyms-on-android.html).

Reading kallsyms with kptr restrict enabled:
 ```
 adb shell cat /proc/kallsyms | grep commit_creds
 00000000 T commit_creds
 ```
 
 In order for this exploit to resolve symbols,
 you need to
 ````
   adb shell su -c "echo 0 > /proc/sys/kernel/kptr_restrict"
 ```

 And now we can properly see the kernel symbols and their addresses:
 ```
 adb shell cat /proc/kallsyms | grep commit_creds
 c008e138 T commit_creds
 ```

We will make the assumption that we know the location of all kernel symbols. While this not strictly true in practice, it is fairly safe to assume that we will be able to access to kernel symbols one way or another.  Locations of items in memory change with every compilation of the kernel.  OEMs build a kernel for each device/product and that kernel is used across all instances of that device (the kernel can change with sytem upgrades, different regions of the phone, small hardware changes in same device).  If you can obtain the OTA update, factory image, etc for the device, you can extract the necessary symbols in a static manner.  Also, if you are able to obtain root on the device in some other manner (unlocked bootloaders, an 0-day you are holding, etc), you can use that to bootsrap yourself to get the necessary symbols

Note: Deterministic builds ([here](https://wiki.debian.org/ReproducibleBuilds) and [here](https://blog.torproject.org/category/tags/deterministic-builds))  are interesting for proving the integrity of the build environment.


##Prepare Your Device for the Challeges##

### *** BE CAREFUL: YOU COULD PERMANENTLY BRICK YOUR DEVICE ***
#### *** THESE KERNEL(S) INTENTIONALLY MAKE YOUR DEVICE VULNERABLE ***

This is meant as a learning exercise. I assume no responsibility for any negative things that may happen by you using this code.

The kernels and the challenges were initially made with the Nexus phones in mind, but with some work, should be adaptable to whatever you have on hand to test with.  Prebuilt kernels for a few devices have been added to the bin folder. Support for more would be great.

There are prebuilt kernels for the Nexus 5 (hammerhead) and the Nexus 4 (mako) in the bin folder. You can boot this by puting your phone into it's bootloader using adb (adb reboot bootloader) or holding a particular button sequence.

Booting the kernel in the following manner will not persist this kernel across device reboots. In otherwords,
after you reboot your phone, it will revert back to your stock kernel.

```
fastboot boot bin/hammerhead_boot_3.4-kk-r1_LKM.img
```

If you would like to flash a kernel to your device you can do so by:
```
fastboot flash boot <location to your boot.img>
```

After your device has booted, you can check the kernel version to make sure it booted properly:

```
cat /proc/version
Linux version 3.4.0-g380afe0-dirty (fuzion24@bitbox) (gcc version 4.7 (GCC) ) #7 SMP PREEMPT Sat Mar 1 15:05:14 EST 2014
```


